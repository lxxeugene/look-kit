<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="common/layout/base"> 
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cart Page</title>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <style>
    a,
    button,
    input,
    select,
    h1,
    h2,
    h3,
    h4,
    h5,
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        border: none;
        text-decoration: none;
        background: none;
    
        -webkit-font-smoothing: antialiased;
    }
    
    menu, ol, ul {
        list-style-type: none;
        margin: 0;
        padding: 0;
    }
    /* 컨테이너 및 기본 설정 */
 .cart-container {
   padding: 0px 280px 140px 280px;
   display: flex;
   flex-direction: column;
   gap: 0px;
   align-items: center;
   justify-content: flex-start;
   flex: 1;
   position: relative;
 }
 
 .cart-title {
   color: #101010;
   text-align: center;
   font-family: "Inter-Regular", sans-serif;
   font-size: 20px;
   line-height: 34px;
   font-weight: 400;
   width: 100%;
   margin: 40px 0; /* 제목이 최상단에 위치하도록 여백 추가 */
   display: flex;
   align-items: center;
   justify-content: center;
 }
 
 /* 장바구니 헤더 */
 .cart-header {
    width: 100%;
    display: flex;
    /* margin-bottom: 20px; */
    border-top: 1px solid #101010;
    padding: 20px;
    gap: 760px;
    flex-direction: row;
    justify-content: space-between;
  }
 
 
 .select-delete-button {
   display: flex;
   align-items: center;
   gap: 5px;
   color: #6a6a6a;
   cursor: pointer;
   background: none;
   border: none;
 }
 
 /* 아이템 리스트 */
 .cart-item-list {
   width: 100%;
   display: flex;
   flex-direction: column;
   gap: 20px;
 }
 
 .store-header {
  width: 100%;
  display: flex;
  /* margin-bottom: 20px; */
  border-top: 1px solid #101010;
  padding: 20px;
  /* gap: 70px; */
  flex-direction: row;
   
 }
 
 .cart-item {
   display: flex;
   align-items: center;
   justify-content: space-between; /* 각 상품 정보를 양쪽으로 배치 */
   padding: 20px;
   border: 1px solid #e6e6e6;
   border-radius: 5px;
   width: 100%;
 }
 
 .item-checkbox {
   flex: 0 0 auto; /* 고정 크기 */
 }
 
 .item-thumbnail img {
   width: 80px;
   height: 80px;
   object-fit: cover;
   border-radius: 5px;
 }
 
 .item-description {
   display: flex;
   flex-direction: column;
   gap: 5px;
   flex: 1; /* 남는 공간 차지 */
   margin-left: 20px;
 }
 .brand-name2 {
   color: #212529;
   font-size: 11px;
 }
 .product-name {
   font-size: 14px;
   color: #767676;
 }
 
 .product-variant {
   font-size: 13px;
   color: #7b7b7b;
 }
 
 /* 좋아요 버튼 */
 .item-like-button {
   margin-right: 10px;
 }
 
 .like-button {
   background: none;
   border: none;
   cursor: pointer;
 }
 
 /* 상품 가격 */
 .item-price {
   font-size: 16px;
   font-weight: bold;
   color: #101010;
 }
 .updateditem-price {
   font-size: 16px;
   font-weight: bold;
   color: #101010;
 }
 .item-price-box {
    display: flex;
    flex-direction: column;
    gap: 5px;
    flex: 1;
    margin-right: 15px;
 }
 
 /* 옵션 및 수량 변경 버튼 */
 .quantity-input {
   background: none;
   border: 1px solid #6a6a6a;
   border-radius: 24px;
   padding: 5px 15px;
   display: flex;
   align-items: center;
   gap: 5px;
   cursor: pointer;
 }
 .item-options-button {
   margin-right: 20px;
 }
 
 .options-button {
   background: none;
   border: 1px solid #6a6a6a;
   border-radius: 24px;
   padding: 5px 15px;
   display: flex;
   align-items: center;
   gap: 5px;
   cursor: pointer;
 }
 
 .options-icon {
   width: 10px;
 }
 
 /* 바로구매 및 삭제 버튼 */
 .item-purchase-buttons {
   display: flex;
   gap: 10px;
 }
 .item-quantity {
  width: 30px;
  margin-left: 16px;
  margin-right: 10px;
 
 }
 .purchase-now-button {
   background-color: #062236;
   color: #ffffff;
   border-radius: 32px;
   padding: 10px 20px;
   border: none;
   cursor: pointer;
 }
 
 .cart-actions {
  flex: 1 1 30%;
  display: flex;
  justify-content: flex-end;

 }
 .delete-item-button {
   background: none;
   border: none;
   color: #8c8c8c;
   display: flex;
   align-items: center;
   gap: 5px;
   cursor: pointer;
 }
 .all-delete-button {
   display: flex;
   align-items: center;
   gap: 5px;
   color: #6a6a6a;
   cursor: pointer;
   background: none;
   border: none;
 }
 
 /* 결제 요약 */
 .cart-summary {
   width: 100%;
   margin-top: 40px;
 }
 
 .summary-header {
   border-top: 1px solid #101010;
   padding-top: 20px;
   margin-bottom: 20px;
 }
 
 .summary-details {
   display: flex;
   flex-wrap: wrap;
   gap: 20px;
   border: 1px solid #e6e6e6;
   padding: 20px;
   border-radius: 5px;
 }
 
 .summary-item {
   flex: 1 1 30%;
   display: flex;
   justify-content: space-between;
   font-size: 14px;
   color: #4a4a4a;
 }
 
 /* 주문하기 버튼 */
 .checkout-button-container {
   width: 100%;
   display: flex;
   justify-content: center;
   margin-top: 30px;
 }
 
 .checkout-button {
   background-color: #062236;
   color: #ffffff;
   padding: 3px 30px;
   border-radius: 54px;
   border: none;
   cursor: pointer;
   display: flex;
   align-items: center;
   gap: 10px;
 }
 
  </style>
</head>
<body>
  <th:block layout:fragment="content">
    <div class="cart-container">
      <div class="cart-title">
        <h2>장바구니</h2>
      </div>
      <div class="cart-header">
        <h3>상품 정보</h3>
        <div class="cart-actions">
          <button class="select-delete-button" id="delete-selected-button">
            <img class="icon-delete" src="/images/icon/icon-delete.svg">
            <span>선택삭제</span>
          </button>
      </div>
      
      
    </div>
  
          <div class="cart-item-list">
        <!-- 장바구니 항목이 여기 추가됩니다 -->
          </div>
          <div class="cart-summary">
        <div class="summary-header">
          <h3>최종 결제 예상 금액</h3>
        </div>
        <div class="summary-details">
          <div class="summary-item">
              <span>총 상품금액</span>
              <strong id="total-price">0원</strong> 
          </div>
          <div class="summary-item">
              <span>최종 결제 예상 금액</span>
              <strong id="total-final-price">0원</strong> 
          </div>
        </div>
        <div class="checkout-button-container">
          <button class="checkout-button" id="checkout-button">
              <span>총 0개 / 0원 주문하기</span>
              <img class="checkout-icon">
          </button>
        </div>
      </div>
</th:block>
<th:block layout:fragment="script">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const cartItemList = document.querySelector(".cart-item-list");

    $.ajax({
      type: "GET",
      url: "/cart/items",
      success: function(cartItems) {
        console.log("장바구니 데이터:", cartItems); // 데이터를 로깅하여 확인합니다.
        if (!Array.isArray(cartItems)) {
          cartItems = []; // 응답 데이터가 배열이 아니면 빈 배열로 초기화합니다.
        }

        cartItems.forEach(item => {
          const productPrice = item.productPrice;


          const cartItemHTML = `
            <div class="cart-item" data-cart-id="${item.cartId}">
              <div class="item-checkbox">
                <input type="checkbox" class="checkbox-input" checked />
              </div>
              <div class="item-thumbnail">
                <a href="/product/${item.productId}">
                  <img class="thumbnail-img" src="/images/products/0${item.productId}/${item.productId}_thumbnail.webp" alt="상품 이미지" />
                </a>
              </div>
              <div class="item-description">
                <div class="brand-name2">${item.brandName}</div>
                <div class="product-name">${item.productName}</div>
                <div class="product-variant">${item.quantity}개</div>
              </div>
              <div class="item-price-box">
                <div class="item-price">
                  <strong>${productPrice.toLocaleString()}원</strong>
                </div>
                <div class="updateditem-price">
                  <strong>${productPrice.toLocaleString()}원</strong>
                </div>
              </div>
              <div>
                <input class="item-quantity quantity-input" type="number" value="${item.quantity}" min="1" data-cart-id="${item.cartId}" />
              </div>
            </div>`;
          cartItemList.insertAdjacentHTML("beforeend", cartItemHTML);
        });
        updateTotalPrice();
      },
      error: function() {
        alert("장바구니 데이터를 불러오는 데 실패했습니다.");
      }
    });

    $(document).on("change", ".item-quantity", function () {
      const cartId = $(this).closest(".cart-item").data("cart-id");
      const newQuantity = parseInt($(this).val());

      if (newQuantity <= 0) {
        alert("수량은 1 이상이어야 합니다.");
        return;
      }

      $.ajax({
        type: "POST",
        url: "/cart/update",
        data: { cartId: cartId, quantity: newQuantity },
        success: function() {
          updateTotalPrice();
      },
        error: function() {
          alert("수량을 변경하는 데 실패했습니다.");
        }
      });
    });

    $("#delete-selected-button").click(function () {
      const selectedItems = $(".checkbox-input:checked").map(function() {
        return $(this).closest(".cart-item").data("cart-id");
      }).get();

      if (selectedItems.length === 0) {
        alert("선택된 항목이 없습니다.");
        return;
      }

      $.ajax({
        type: "POST",
        url: "/cart/delete",
        data: { cartIds: selectedItems },
        traditional: true,
        success: function() {
          selectedItems.forEach(cartId => {
            $(`[data-cart-id='${cartId}']`).remove();
          });
          updateTotalPrice();
          $(".checkbox-input").prop("checked", true);
        },
        error: function() {
          alert("선택된 상품을 삭제하는 데 실패했습니다.");
        }
      });
    });

    $(document).on("change", ".checkbox-input", function () {
      updateTotalPrice();
    });

    function updateTotalPrice() {
      let totalAmount = 0;
      let totalQuantity = 0;

      $(".cart-item").each(function () {
        const quantity = parseInt($(this).find(".item-quantity").val());
        const price = parseInt($(this).find(".item-price strong").text().replace(/\D/g, ""));

        if (!isNaN(quantity) && !isNaN(price)) {
          totalAmount += quantity * price;
          totalQuantity += quantity;
        }
      });

      $("#total-price").text(totalAmount.toLocaleString() + "원");
      $("#total-final-price").text(totalAmount.toLocaleString() + "원");
      $("#checkout-button span").text(`총 ${totalQuantity}개 / ${totalAmount.toLocaleString()}원 주문하기`);
    }

    $("#checkout-button").click(function() {
      location.href = "/cart/checkout";
    });
  });
</script>
</th:block>
</body>
</html>
